name: AZ_TEST

on:
  pull_request:

permissions:
  id-token: write
  contents: read

jobs:
  test:
    runs-on: ubuntu-22.04
    steps:
    - name: Log into Azure
      uses: azure/login@v1
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}      

    - name: Fetch secrets
      run: |
        az keyvault secret show --vault-name "bpfperformacesecrets" --name "PGDATABASE" --query value >> ${{env.workspace}}/PGDATABASE
        az keyvault secret show --vault-name "bpfperformacesecrets" --name "PGHOST" --query value >> ${{env.workspace}}/PGDATABASE
        az keyvault secret show --vault-name "bpfperformacesecrets" --name "PGUSER" --query value >> ${{env.workspace}}/PGUSER
        az keyvault secret show --vault-name "bpfperformacesecrets" --name "PGPASSWORD" --query value >> ${{env.workspace}}/PGPASSWORD
        az keyvault secret show --vault-name "bpfperformacesecrets" --name "PGPORT" --query value" >> ${{env.workspace}}/PGPORT

    - name: Test POSTGRES access
      run: |
        export PGPASSWORD=$(cat ${{env.workspace}}/PGPASSWORD)
        export PGHOST=$(cat ${{env.workspace}}/PGHOST)
        export PGUSER=$(cat ${{env.workspace}}/PGUSER)
        export PGPORT=$(cat ${{env.workspace}}/PGPORT)
        export PGDATABASE=$(cat ${{env.workspace}}/PGDATABASE)
        psql -c "SELECT * FROM BenchmarkResults LIMIT 50"

  
